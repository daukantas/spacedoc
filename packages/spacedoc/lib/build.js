const filter = require('lodash.filter');
const fromPairs = require('lodash.fromPairs');
const path = require('path');
const yaml = require('js-yaml');
const helpers = require('spacedoc-helpers');

/**
 * Create an HTML page out of a documentation object.
 * @param {PageData} data - Page object generated by `Spacedoc.parse()`.
 * @throws Will throw an error if no template was set with `Spacedoc.config()`.
 * @throws Will throw an error if the template encounters an error while rendering.
 * @returns {String} Rendered HTML string.
 */
module.exports = function build(data = {}) {
  // Render a template with the component's data and write it to disk
  let output = '';

  if (data.layout && !this.multiTemplate) {
    console.warn(`Spacedoc: alternate layouts cannot be used if only a single template was passed to Spacedoc.config(). (Layout set by ${data.fileName})`);
  }

  // Use a page-defined layout or the default one
  const layout = this.multiTemplate ? (data.layout || 'default') : 'default';

  // Extend file data with global data and template locals
  data = Object.assign({}, this.options.data, data, {
    helpers: Object.assign({
      find: (scope, predicate = {}) => {
        if (scope in data.docs) {
          return filter(data.docs[scope], predicate);
        }
        return []
      }
    }, helpers),
    categories: fromPairs(Object.keys(this.adapters).map(a => [a, this.adapters[a].order])),
    site: Object.assign({}, this.options.site, {
      pages: this.tree,
    }),
  });

  // Render the set layout
  if (layout in this.templates) {
    // Manually catch template errors, because Gulp won't display them
    try {
      output = this.templates[layout](data);
    }
    catch (e) {
      console.warn('Spacedoc.build(): ', e);
    }
  }
  else {
    console.warn(`Spacedoc.build(): no layout called ${layout} exists. (Set by ${data.fileName})`);
  }

  // Preserve Front Matter if configured to
  if (this.options.keepFm) {
    output = `---\n${yaml.safeDump(data._frontMatter)}\n---\n\n${output}` ;
  }

  return output;
}

const fs     = require('fs');
const path   = require('path');
const rimraf = require('rimraf');
const yaml   = require('js-yaml');

/**
 * Create an HTML page out of a documentation object.
 * @param {PageData} data - Page object generated by `Spacedoc.parse()`.
 * @throws Will throw an error if no template was set with `Spacedoc.config()`.
 * @throws Will throw an error if the template encounters an error while rendering.
 * @returns {String} Rendered HTML string.
 */
module.exports = function build(data) {
  // A template is required to build
  if (this.template === null) {
    throw new Error('Spacedoc.build(): a template is required to build.');
  }

  // Render a template with the component's data and write it to disk
  let output = '';

  // Extend file data with global data
  data = Object.assign({}, this.options.data, data);

  // Catch Handlebars errors, because they won't show up in the Gulp console
  try {
    output = this.template(data);
  }
  catch(e) {
    throw new Error('Template error: ' + e.message);
  }

  if (this.options.keepFm) {
    output = '---\n' + yaml.safeDump(data._frontMatter) + '\n---\n\n' + output;
  }

  return output;
}
